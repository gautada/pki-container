#!/bin/sh

# This is a script to mount the encrypted ca.vhd making it available to the pki docker container.
# VAULT=$1
# PKI_PATH="/home/mada/Development/Configuration/pki"
# VHD_FILE="$PKI_PATH/disks/$VAULT.vhd"
# VAULT_PATH="$PKI_PATH/vaults/$VAULT"
# echo $VAULT_PATH
# if [ -f $VHD_FILE ] ; then
#     if [ -f "$VAULT_PATH/.last" ] ; then
#         echo "Vault '$VAULT' is already mounted"
#     else
#         sudo cryptsetup luksOpen "$VHD_FILE" "$VAULT.crypt"
#         sudo mount "/dev/mapper/$VAULT.crypt" "$VAULT_PATH"
#         date +%s > "$VAULT_PATH/.last"
#     fi
# else
#    echo "Cannot find the virtual hard drive (vhd) file for vault '$VAULT' to mount"
# fi

PKILIB_PATH=/var/lib/pki
if [ -d $PKILIB_PATH ] ; then
 cd $PKILIB_PATH
 if [ -d $PKILIB_PATH/.git ] ; then 
   echo "Updating ecrypted virtual drives"
   git pull
 else
   echo "No repository found, Key repository should be cloned to ($PKILIB_PATH)."
 fi
 for p in $PKILIB_PATH/*.evd ; do # loop through the evd files 
   if [ -f $p ] ; then
     f=${p%.evd}
     v=${f##*/}
     if [ -d /mnt/pki/$v ] ; then
       read -n4 -p "Decrypt and mount encrypted virtual drive $p as $v? (type capitalized 'yes' to confirm) " confirm 
       echo
       case $confirm in  
         "YES") echo "Opening $p as $v" \
               && sudo cryptsetup luksOpen $p $v \
               && echo "Mounting $v as /mnt/pki/$v" \
               && sudo mount "/dev/mapper/$v" "/mnt/pki/$v" ;; 
         *) echo "Will not mount $v." ;; 
       esac
       if [ $? -eq 0 ] ; then
	 echo "Successfully mounted $v."
         date +%s > "/mnt/pki/$v/.last"
       else
	 echo "Failed with exit code $?."
         echo "Attempting Rollback"
         sudo umount "/mnt/pki/$v"
         sudo cryptsetup luksClose $v
       fi
       echo "Completed with exit code $?."
     else
       echo "No mount point (/mnt/pki/$v) found."
     fi
   fi
  done
else
  echo "No pki library found ($PKILIB_PATH)."
fi
cd
