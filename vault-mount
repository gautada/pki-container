#!/bin/sh

# A script to mount a vault  this is interactive and will always require the password to be provided.

VAULT=$1

if [ ! -f /opt/pki/$VAULT.vhd ] ; then
 echo "[ERROR] Virtual hard drive ($VAULT.vhd) not found."
 exit 99
fi

sudo cryptsetup status $VAULT.evhd
if [ ! $? -eq 0 ] ;  then # check device exists
 sudo cryptsetup luksOpen /opt/pki/$VAULT.vhd $VAULT.evhd
fi

if [ ! -f /mnt/$VAULT/.last ] ; then
 sudo mount /dev/mapper/$VAULT.evhd /mnt/$VAULT
 vault-refresh $VAULT
fi

sudo chown -R pki:pki /mnt/$VAULT


