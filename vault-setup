#!/bin/sh

# vault-setup: Creates the encrypted virtual hard disk for the vault and mounts the vault to the default mount point then creates a root certificate authority then unmounts the vault for security.

MOUNT_POINT=/mnt/vault

if [ ! -d "/mnt/vault" ] ; then
 echo "[ERROR] vault mount point(/mnt/vault) does not exists"
 exit 1
fi
if [ -f "/opt/pki/vault.evhd" ] ; then
 echo "[ERROR] Vault(/opt/pki/vault.evhd) previously setup"
 exit 2
fi

echo "Creating virtual hard drive for vault"
/bin/dd if=/dev/urandom of=/opt/pki/vault.evhd bs=1M count=100

echo "Encrypting virtual hard drive for vault"
/usr/bin/sudo /sbin/cryptsetup --type=luks2 --verify-passphrase luksFormat /opt/pki/vault.evhd

echo "Open vault device"
/usr/bin/sudo /sbin/cryptsetup luksOpen /opt/pki/vault.evhd vault
if [ ! $? -eq 0 ] ;  then
 echo "[ERROR] Unable to open vault(/opt/pki/vault.evhd)."
 echo "- - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
 echo "3"
 ls -l /dev/mapper
 exit 3
fi

echo "Formating vault device"
/usr/bin/sudo /sbin/mkfs.ext4 /dev/mapper/vault
if [ ! $? -eq 0 ] ;  then
 echo "[ERROR] Unable to format vault device(/dev/mapped/vault)."
 echo "- - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
 ls -l /dev/mapper
 exit 4
fi

echo "Close vault device"
/usr/bin/sudo /sbin/cryptsetup luksClose vault
if [ ! $? -eq 0 ] ;  then
 echo "[ERROR] Unable to close the vault."
 exit 5
fi

echo "Set vault mount point ownership"
/usr/bin/sudo chown pki:pki $MOUNT_POINT

echo "Mount the vault"
/usr/bin/vault-mount
RTN=$?
if [ ! $RTN -eq 0 ] ;  then
 exit $RTN
fi

# echo "Checking status of vault"
# /bin/df -h
# echo "- - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
# ls -lh /mnt/ca
# echo "- - - - - - - - - - - - - - - - - - - - - - - - - - - - -"
echo "Create the Root CA"
/usr/bin/easypki --root $MOUNT_POINT/ca create --filename root --ca "Root Certificate Authority"

echo "Unmount the vault"
/usr/bin/vault-umount
RTN=$?
if [ ! $RTN -eq 0 ] ;  then
 exit $RTN
fi

echo "Removing vault setup script"
rm -rf /usr/bin/vault-setup
exit 0
