#!/bin/sh

# Script to run once on the first run to setup ca-root and ca vaults which will:
# 1. create the vaults
# 2. create the keys for ca-root vault
# 3. create the keys for ca
# 4. Link the ca-root and ca together
# finally unmount vault ca-root
# refresh vault ca
if [ -z $1 ] ; then
 echo "[ERROR] Domain default is required for initial pki setup"
 exit 99
fi

if [ -f /opt/pki-data/ca-root.vhd ] ; then
 echo "[ERROR] CA-ROOT vault is already created"
 exit 98
fi

if [ -f /opt/pki-data/ca.vhd ] ; then
 echo "[ERROR] CA vault is already created"
 exit 97
fi

vault-umount ca-root
vault-setup ca-root
date +%s > /mnt/ca-root/.last

vault-umount ca
vault-setup ca
date +%s > /mnt/ca/.last

# Create ca-root and ca
DOMAIN=$1

# Build CA
easypki --root /mnt/ca-root create --filename root --ca "Personal Certificate Authority - $DOMAIN"
# Build CA (Intermediate)
easypki --root /mnt/ca-root create --ca-name root --filename ca.$DOMAIN --intermediate "Certificate Authority for ca.$DOMAIN"
mv /mnt/ca-root/ca.$DOMAIN /mnt/ca/ca.$DOMAIN

vault-umount ca-root


